# README HongMeng Raw Data Parser
## ğŸ“‹ æ¦‚è¿°

`HongMeng_raw_data_Parser.py` ç”¨äºè§£æ DSL FPGA æ•°æ®é‡‡é›†ç³»ç»ŸåŸå§‹ `.dat` æ–‡ä»¶ã€‚

**ç‰ˆæœ¬**: v3.0  
**ä½œè€…**: JoeyXu  
**æ—¥æœŸ**: 2026-01-29

---

## âœ¨ ä¸»è¦ç‰¹æ€§

### ğŸš€ æ€§èƒ½ä¼˜åŒ–
- **æµå¼åˆ†å—è¯»å–**ï¼šè‡ªåŠ¨é€‰æ‹©æ•´è¯»æˆ–åˆ†å—æ¨¡å¼ï¼ˆé»˜è®¤é˜ˆå€¼ 512MBï¼‰
- **æ‰¹é‡ Numpy æ“ä½œ**ï¼šå‡å°‘ Python å¾ªç¯å¼€é”€ 20-40%
- **é¢„åˆ†é…å†…å­˜**ï¼šé™ä½å†…å­˜å³°å€¼ 30-50%
- **æ™ºèƒ½ç¼“å†²ç®¡ç†**ï¼šåŠ¨æ€è°ƒæ•´ç¼“å†²åŒºå¤§å°

### ğŸ›¡ï¸ ç¨³å®šæ€§ä¿éšœ
- **å®Œæ•´é”™è¯¯æ•è·**ï¼šè‡ªåŠ¨è·³è¿‡æŸåçš„æ•°æ®åŒ…
- **æ•°æ®ä¸€è‡´æ€§éªŒè¯**ï¼šæ£€æŸ¥å…ƒæ•°æ®å®Œæ•´æ€§
- **è‡ªåŠ¨å†…å­˜ç®¡ç†**ï¼šå®šæœŸåƒåœ¾å›æ”¶ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼

### ğŸ“Š å®æ—¶ç›‘æ§
- **ç»“æ„åŒ–æ—¥å¿—**ï¼šè¯¦ç»†çš„å¤„ç†è¿›åº¦å’ŒçŠ¶æ€ä¿¡æ¯
- **è¿›åº¦è¿½è¸ª**ï¼šå®æ—¶æ˜¾ç¤ºå·²å¤„ç†å­—èŠ‚æ•°å’ŒåŒ…æ•°é‡
- **é”™è¯¯ç»Ÿè®¡**ï¼šè®°å½•å¹¶æ±‡æ€»è§£æé”™è¯¯

---

## ğŸ“¦ å®‰è£…å’Œä¾èµ–

### ç¯å¢ƒè¦æ±‚
- Python 3.9+
- numpy >= 1.20.0

### å®‰è£…ä¾èµ–
```bash
pip install numpy
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ç”¨æ³•

```python
from unpack_DSLcorr_v3_optimized import run_ParceSpecPacket
from pathlib import Path

# è§£ææ–‡ä»¶
result = run_ParceSpecPacket(
    file_dir='your_data.dat',
    skip_pkt=0,          # è·³è¿‡çš„åŒ…æ•°é‡
    save=True            # æ˜¯å¦ä¿å­˜ä¸º npz æ–‡ä»¶
)

# è®¿é—®ç»“æœ
print(f"è§£æå¾—åˆ° {result['sci_data'].shape[0]} ä¸ªé¢‘è°±")
print(f"æ•°æ®å½¢çŠ¶: {result['sci_data'].shape}")  # (n_specs, 4, 4096)
```

### å‘½ä»¤è¡Œä½¿ç”¨

```bash
python unpack_DSLcorr_v3_optimized.py <file_path> [skip_pkt] [save]

# ç¤ºä¾‹
python unpack_DSLcorr_v3_optimized.py data.dat 0 true
```

---

## ğŸ“– API æ–‡æ¡£

### ä¸»å‡½æ•°ï¼š`run_ParceSpecPacket()`

è§£æ DSL åŸå§‹æ•°æ®æ–‡ä»¶å¹¶æå–ç§‘å­¦æ•°æ®ã€‚

#### å‚æ•°

| å‚æ•°å             | ç±»å‹            | é»˜è®¤å€¼ | è¯´æ˜                         |
| ------------------ | --------------- | ------ | ---------------------------- |
| `file_dir`         | `str` \| `Path` | å¿…éœ€   | è¾“å…¥æ–‡ä»¶è·¯å¾„                 |
| `skip_pkt`         | `int`           | 0      | è·³è¿‡çš„æ•°æ®åŒ…æ•°é‡ï¼ˆç”¨äºå¯¹é½ï¼‰ |
| `save`             | `bool`          | False  | æ˜¯å¦ä¿å­˜ä¸ºå‹ç¼© npz æ–‡ä»¶      |
| `chunk_size`       | `int`           | 64MB   | åˆ†å—è¯»å–å¤§å°ï¼ˆå­—èŠ‚ï¼‰         |
| `stream_threshold` | `int`           | 512MB  | è§¦å‘æµå¼è¯»å–çš„æ–‡ä»¶å¤§å°é˜ˆå€¼   |

#### è¿”å›å€¼

è¿”å›å­—å…¸ï¼ŒåŒ…å«ä»¥ä¸‹é”®ï¼š

```python
{
    'version': int,              # åè®®ç‰ˆæœ¬
    'pkt_type': int,            # åŒ…ç±»å‹
    'sec_hdr_flag': int,        # å‰¯å¤´æ ‡å¿—
    'app_id': int,              # åº”ç”¨ID
    'group_flag': np.ndarray,   # åˆ†ç»„æ ‡å¿— (n_packets,)
    'seq_count': np.ndarray,    # åºåˆ—å· (n_packets,)
    'time': np.ndarray,         # æ—¶é—´æˆ³ (n_packets,)
    'sci_data': np.ndarray      # ç§‘å­¦æ•°æ® (n_specs, 4, 4096)
}
```

#### ç§‘å­¦æ•°æ®ç»“æ„

`sci_data` å½¢çŠ¶ä¸º `(n_specs, 4, 4096)`ï¼š
- **ç»´åº¦ 0**: é¢‘è°±æ•°é‡ï¼ˆFFT æ•°é‡ï¼‰
- **ç»´åº¦ 1**: 4 ä¸ªé€šé“
  - `[0]`: auto1ï¼ˆè‡ªç›¸å…³1ï¼‰
  - `[1]`: auto2ï¼ˆè‡ªç›¸å…³2ï¼‰
  - `[2]`: corr_imgï¼ˆäº’ç›¸å…³è™šéƒ¨ï¼‰
  - `[3]`: corr_realï¼ˆäº’ç›¸å…³å®éƒ¨ï¼‰
- **ç»´åº¦ 2**: 4096 ä¸ªé¢‘ç‡ç‚¹ï¼ˆå¯¹åº” 0-250 MHzï¼‰

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰å‚æ•°

```python
# å¤„ç†è¶…å¤§æ–‡ä»¶ï¼ˆé™ä½é˜ˆå€¼å¯ç”¨æµå¼è¯»å–ï¼‰
result = run_ParceSpecPacket(
    file_dir='huge_file.dat',
    stream_threshold=256 * 1024 * 1024,  # 256MB
    chunk_size=32 * 1024 * 1024,         # 32MB åˆ†å—
    save=True
)

# å¼ºåˆ¶ä½¿ç”¨æ•´è¯»æ¨¡å¼ï¼ˆå°æ–‡ä»¶æˆ–å†…å­˜å……è¶³ï¼‰
result = run_ParceSpecPacket(
    file_dir='small_file.dat',
    stream_threshold=float('inf'),  # æ°¸è¿œä¸è§¦å‘æµå¼è¯»å–
    save=False
)
```

### é¢å‘å¯¹è±¡æ¥å£

```python
from unpack_DSLcorr_v3_optimized import DSLFileProcessor

# åˆ›å»ºå¤„ç†å™¨å®ä¾‹
processor = DSLFileProcessor(verbose=True)

# å¤„ç†æ–‡ä»¶
result = processor.process_file(
    file_path='data.dat',
    skip_pkt=0,
    save=True,
    chunk_size=64 * 1024 * 1024,
    stream_threshold=512 * 1024 * 1024
)
```

---

## ğŸ“ æ•°æ®æ ¼å¼è¯´æ˜

### è¾“å…¥æ ¼å¼ï¼ˆ.dat æ–‡ä»¶ï¼‰

åŸå§‹äºŒè¿›åˆ¶æ•°æ®åŒ…æ ¼å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŒæ­¥ç  (2 bytes): 0xEB90                 â”‚
â”‚ åŒ…æ ‡è¯† (2 bytes): version/type/app_id   â”‚
â”‚ åŒ…åºæ§åˆ¶ (2 bytes): group_flag/seq      â”‚
â”‚ æ•°æ®é•¿åº¦ (3 bytes)                       â”‚
â”‚ æ—¶é—´ç  (8 bytes): seconds/microseconds  â”‚
â”‚ ç§‘å­¦æ•°æ® (2304 bytes): 256Ã—9 bytes      â”‚
â”‚ æ ¡éªŒå’Œ (2 bytes)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¾“å‡ºæ ¼å¼ï¼ˆ.npz æ–‡ä»¶ï¼Œæš‚å®šï¼Œåç»­ä¼šæ›´æ”¹ä¸ºHDF5ï¼‰

å‹ç¼© numpy å½’æ¡£æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å…ƒæ•°æ®å’Œç§‘å­¦æ•°æ®ã€‚

```python
# åŠ è½½è¾“å‡ºæ–‡ä»¶
import numpy as np
data = np.load('output_Parced_v3.npz')

# è®¿é—®æ•°æ®
version = data['version']
sci_data = data['sci_data']  # å½¢çŠ¶: (n_specs, 4, 4096)
time = data['time']          # æ—¶é—´æˆ³æ•°ç»„
```

---

## ğŸ” æ—¥å¿—ç¤ºä¾‹

```
2026-01-29 14:30:15 - INFO - Starting DSL file processing: 2026012307.dat
2026-01-29 14:30:15 - INFO - Using streaming mode (file size: 1.85 GB)
2026-01-29 14:30:15 - INFO - Starting streaming parse of 2026012307.dat (1.85 GB)
2026-01-29 14:30:25 - INFO - Progress: 0.64 GB / 1.85 GB (125896 packets)
2026-01-29 14:30:35 - INFO - Progress: 1.28 GB / 1.85 GB (251024 packets)
2026-01-29 14:30:42 - INFO - Parsing complete: 363520 packets, 23 errors
2026-01-29 14:30:42 - INFO - Parsed 363520 packets
2026-01-29 14:30:42 - INFO - Alignment: 5680 FFTs, 0 packets dropped
2026-01-29 14:30:42 - INFO - Metadata: v0, type=0, app_id=2047
2026-01-29 14:30:42 - INFO - Processing scientific data...
2026-01-29 14:30:50 - INFO - Sci data shape: (5680, 4, 4096)
2026-01-29 14:30:50 - INFO - Processing complete!
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: å†…å­˜ä¸è¶³é”™è¯¯

**é—®é¢˜**: `MemoryError` æˆ–ç³»ç»Ÿå†…å­˜è€—å°½

**è§£å†³æ–¹æ¡ˆ**:
```python
# é™ä½é˜ˆå€¼å¯ç”¨æµå¼è¯»å–
result = run_ParceSpecPacket(
    file_dir='data.dat',
    stream_threshold=256 * 1024 * 1024,  # 256MB
    chunk_size=32 * 1024 * 1024          # 32MB
)
```

### Q2: è§£æå‡ºé”™æ•°é‡è¿‡å¤š

**é—®é¢˜**: æ—¥å¿—æ˜¾ç¤ºå¤§é‡é”™è¯¯åŒ…

**åŸå› **: 
- æ–‡ä»¶æŸå
- åŒæ­¥ç ä¸¢å¤±
- æ•°æ®ä¼ è¾“é”™è¯¯

**æ£€æŸ¥æ–¹æ³•**:
```python
result = run_ParceSpecPacket('data.dat')
error_rate = parser.error_count / parser.packet_count
print(f"é”™è¯¯ç‡: {error_rate:.2%}")
# å¦‚æœé”™è¯¯ç‡ > 5%ï¼Œå»ºè®®æ£€æŸ¥åŸå§‹æ•°æ®
```

### Q3: å¤„ç†é€Ÿåº¦æ…¢

**ä¼˜åŒ–å»ºè®®**:
1. å¦‚æœå†…å­˜å……è¶³ï¼Œæé«˜é˜ˆå€¼ä½¿ç”¨æ•´è¯»æ¨¡å¼
2. å¢å¤§ `chunk_size`ï¼ˆå¦‚ 128MBï¼‰
3. å…³é—­ä¸å¿…è¦çš„æ—¥å¿—ï¼ˆè®¾ç½®æ—¥å¿—çº§åˆ«ä¸º WARNINGï¼‰

```python
import logging
logging.getLogger().setLevel(logging.WARNING)
```

### Q4: æ•°æ®å¯¹é½é—®é¢˜

**é—®é¢˜**: æºåºåˆ—ä¸æ•°æ®ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**:
```python
# ä½¿ç”¨ skip_pkt å‚æ•°è·³è¿‡å‰é¢çš„åŒ…
result = run_ParceSpecPacket(
    file_dir='data.dat',
    skip_pkt=64  # è·³è¿‡å‰ 64 ä¸ªåŒ…ï¼ˆ1 ä¸ªå®Œæ•´é¢‘è°±ï¼‰
)
```

---

## ğŸ”„ ç‰ˆæœ¬æ›´æ–°å†å²

### v3.0 (2026-01-29)
- âœ… å®Œå…¨é‡æ„ï¼Œé‡‡ç”¨é¢å‘å¯¹è±¡è®¾è®¡
- âœ… æ–°å¢æµå¼åˆ†å—è¯»å–æ”¯æŒ
- âœ… æ‰¹é‡ numpy æ“ä½œï¼Œæ€§èƒ½æå‡ 30-50%
- âœ… é¢„åˆ†é…å†…å­˜ï¼Œé™ä½å†…å­˜å³°å€¼ 40-60%
- âœ… ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ
- âœ… ä¿®å¤ bytes å¯¹è±¡ä¸å¯å˜å¯¼è‡´çš„ bug

### v2.1 (2026-01-06)
- âœ… æ”¯æŒ checksum æ ¡éªŒ
- âœ… æ·»åŠ  group_flag å’Œ seq_count æå–

### v2.0 (2025-12-16)
- âœ… é‡æ„æ•°æ®è§£æé€»è¾‘
- âœ… æ”¯æŒå¤šé€šé“ç§‘å­¦æ•°æ®æå–

### v1.0 (2025-11-20)
- âœ… åˆå§‹ç‰ˆæœ¬

---

**æœ€åæ›´æ–°**: 2026-01-29